<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Christmas Trivia Party</title>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Mountains+of+Christmas:wght@400;700&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
  
  <!-- PeerJS -->
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  
  <!-- QRCode -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  
  <!-- Questions (external file) -->
  <script src="questions.js"></script>
  
  <style>
    /* ========================================
       THEME CONFIGURATION
       ======================================== */
    :root {
      --color-primary: #c41e3a;
      --color-primary-dark: #9a162d;
      --color-secondary: #165B33;
      --color-secondary-dark: #0f4025;
      --color-accent: #FFD700;
      --color-accent-glow: rgba(255, 215, 0, 0.4);
      --color-background: #0a120a;
      --color-surface: #132613;
      --color-surface-light: #1a3a1a;
      --color-text: #ffffff;
      --color-text-muted: #8cb88c;
      --color-correct: #22c55e;
      --color-wrong: #ef4444;
      
      --font-display: 'Mountains of Christmas', cursive;
      --font-body: 'Nunito', sans-serif;
      
      --shadow-glow: 0 0 30px rgba(255, 215, 0, 0.3);
      --shadow-card: 0 8px 32px rgba(0, 0, 0, 0.4);
      
      /* Safe area insets for notched phones */
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-left: env(safe-area-inset-left, 0px);
      --safe-right: env(safe-area-inset-right, 0px);
    }

    /* ========================================
       RESET & BASE
       ======================================== */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      height: 100%;
      height: -webkit-fill-available;
    }

    body {
      font-family: var(--font-body);
      background: var(--color-background);
      color: var(--color-text);
      line-height: 1.5;
      min-height: 100%;
      min-height: -webkit-fill-available;
      overflow: hidden;
      position: fixed;
      width: 100%;
      -webkit-tap-highlight-color: transparent;
    }

    /* ========================================
       BACKGROUND & DECORATIONS
       ======================================== */
    #app {
      min-height: 100vh;
      min-height: -webkit-fill-available;
      background: 
        radial-gradient(ellipse at top, var(--color-secondary-dark) 0%, transparent 50%),
        radial-gradient(ellipse at bottom, var(--color-primary-dark) 0%, transparent 50%),
        var(--color-background);
      position: relative;
      overflow: hidden;
    }

    /* Snowfall */
    .snowflake {
      position: fixed;
      top: -10px;
      color: #fff;
      font-size: 1em;
      text-shadow: 0 0 5px #fff;
      animation: fall linear infinite;
      pointer-events: none;
      z-index: 1000;
      opacity: 0.7;
    }

    @keyframes fall {
      0% { transform: translateY(-10px) rotate(0deg); }
      100% { transform: translateY(100vh) rotate(360deg); }
    }

    /* Christmas Lights */
    .lights-container {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 30px;
      display: flex;
      justify-content: center;
      z-index: 100;
      pointer-events: none;
    }

    .light-bulb {
      width: 12px;
      height: 18px;
      border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
      margin: 8px 15px 0;
      animation: glow 1s ease-in-out infinite alternate;
    }

    .light-bulb:nth-child(5n+1) { background: #ff6b6b; box-shadow: 0 0 15px #ff6b6b; animation-delay: 0s; }
    .light-bulb:nth-child(5n+2) { background: #4ecdc4; box-shadow: 0 0 15px #4ecdc4; animation-delay: 0.2s; }
    .light-bulb:nth-child(5n+3) { background: #ffe66d; box-shadow: 0 0 15px #ffe66d; animation-delay: 0.4s; }
    .light-bulb:nth-child(5n+4) { background: #95e1d3; box-shadow: 0 0 15px #95e1d3; animation-delay: 0.6s; }
    .light-bulb:nth-child(5n+5) { background: #f38181; box-shadow: 0 0 15px #f38181; animation-delay: 0.8s; }

    @keyframes glow {
      0% { opacity: 0.6; filter: brightness(0.8); }
      100% { opacity: 1; filter: brightness(1.2); }
    }

    .lights-wire {
      position: fixed;
      top: 12px;
      left: 0;
      right: 0;
      height: 3px;
      background: #222;
      z-index: 99;
    }

    /* ========================================
       LAYOUT CONTAINERS
       ======================================== */
    .screen {
      min-height: 100vh;
      min-height: -webkit-fill-available;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      padding-top: calc(50px + var(--safe-top));
      padding-bottom: calc(20px + var(--safe-bottom));
    }

    .card {
      background: var(--color-surface);
      border: 2px solid var(--color-secondary);
      border-radius: 20px;
      padding: 30px;
      box-shadow: var(--shadow-card);
      max-width: 100%;
    }

    /* ========================================
       TYPOGRAPHY
       ======================================== */
    h1, h2, h3 {
      font-family: var(--font-display);
      color: var(--color-accent);
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }

    h1 { font-size: clamp(2.5rem, 8vw, 4.5rem); margin-bottom: 10px; }
    h2 { font-size: clamp(1.8rem, 5vw, 3rem); }

    .subtitle {
      color: var(--color-text-muted);
      font-size: 1.1rem;
      margin-bottom: 30px;
    }

    /* ========================================
       BUTTONS
       ======================================== */
    .btn {
      font-family: var(--font-body);
      font-weight: 700;
      font-size: 1.1rem;
      padding: 15px 40px;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
      color: white;
      box-shadow: 0 4px 15px rgba(196, 30, 58, 0.4);
    }

    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(196, 30, 58, 0.6); }

    .btn-secondary {
      background: linear-gradient(135deg, var(--color-secondary), var(--color-secondary-dark));
      color: white;
      box-shadow: 0 4px 15px rgba(22, 91, 51, 0.4);
    }

    .btn-secondary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(22, 91, 51, 0.6); }

    .btn-accent {
      background: linear-gradient(135deg, var(--color-accent), #e6c200);
      color: #1a1a1a;
      box-shadow: 0 4px 15px var(--color-accent-glow);
    }

    .btn-large { padding: 20px 60px; font-size: 1.3rem; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }

    /* ========================================
       INPUTS
       ======================================== */
    .input-field {
      font-family: var(--font-body);
      font-size: 1.4rem;
      padding: 18px 24px;
      border: 2px solid var(--color-secondary);
      border-radius: 12px;
      background: var(--color-surface-light);
      color: var(--color-text);
      width: 100%;
      text-align: center;
      transition: all 0.3s ease;
    }

    .input-field:focus {
      outline: none;
      border-color: var(--color-accent);
      box-shadow: 0 0 15px var(--color-accent-glow);
    }

    .input-field::placeholder { color: var(--color-text-muted); }

    /* ========================================
       MODE SELECTION SCREEN
       ======================================== */
    .mode-buttons {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 20px;
    }

    .mode-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
      padding: 30px 40px;
      background: var(--color-surface);
      border: 3px solid var(--color-secondary);
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 200px;
    }

    .mode-btn:hover {
      border-color: var(--color-accent);
      transform: translateY(-5px);
      box-shadow: var(--shadow-glow);
    }

    .mode-btn svg { width: 60px; height: 60px; fill: var(--color-accent); }
    .mode-btn span { font-size: 1.3rem; font-weight: 700; color: var(--color-text); }
    .mode-btn small { color: var(--color-text-muted); font-size: 0.9rem; }

    /* ========================================
       HOST LOBBY
       ======================================== */
    .lobby-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 40px;
      max-width: 1000px;
      width: 100%;
    }

    @media (max-width: 768px) {
      .lobby-container { grid-template-columns: 1fr; }
    }

    .join-info { text-align: center; }

    .room-code {
      font-family: var(--font-display);
      font-size: 4rem;
      color: var(--color-accent);
      letter-spacing: 10px;
      text-shadow: 0 0 20px var(--color-accent-glow);
      margin: 20px 0;
    }

    .qr-container {
      background: white;
      padding: 15px;
      border-radius: 15px;
      display: inline-block;
      margin: 20px 0;
    }

    .qr-container canvas { display: block; }

    .join-url {
      color: var(--color-text-muted);
      font-size: 0.9rem;
      word-break: break-all;
    }

    .players-section h3 { margin-bottom: 20px; font-size: 1.5rem; }

    .players-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 300px;
      overflow-y: auto;
    }

    .player-item {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 12px 20px;
      background: var(--color-surface-light);
      border-radius: 10px;
      border-left: 4px solid var(--color-accent);
    }

    .player-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--color-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1.2rem;
    }

    .player-name { font-weight: 600; font-size: 1.1rem; }

    .waiting-text {
      color: var(--color-text-muted);
      font-style: italic;
      padding: 20px;
      text-align: center;
    }

    .start-section { margin-top: 30px; text-align: center; }
    .player-count { color: var(--color-text-muted); margin-bottom: 15px; }

    /* ========================================
       CONTROLLER - MOBILE OPTIMIZED (FULL SCREEN)
       ======================================== */
    .controller-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      flex-direction: column;
      padding-top: max(12px, var(--safe-top));
      padding-bottom: max(12px, var(--safe-bottom));
      padding-left: max(12px, var(--safe-left));
      padding-right: max(12px, var(--safe-right));
      background: 
        radial-gradient(ellipse at top, var(--color-secondary-dark) 0%, transparent 50%),
        radial-gradient(ellipse at bottom, var(--color-primary-dark) 0%, transparent 50%),
        var(--color-background);
      overflow: hidden;
    }

    .controller-header {
      text-align: center;
      padding: 8px 0 12px;
      flex-shrink: 0;
    }

    .controller-header h2 {
      font-size: clamp(1.5rem, 6vw, 2.5rem);
      margin-bottom: 8px;
    }

    .controller-header .timer {
      display: inline-block;
      font-family: var(--font-body);
      font-size: clamp(2.5rem, 10vw, 4rem);
      font-weight: 800;
      color: var(--color-text);
      background: var(--color-primary);
      padding: 8px 35px;
      border-radius: 50px;
      min-width: 100px;
    }

    .controller-header .timer.warning {
      animation: pulse 0.5s ease-in-out infinite;
      background: var(--color-wrong);
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.08); }
    }

    .controller-answers {
      display: flex;
      flex-direction: column;
      gap: clamp(8px, 2vh, 16px);
      flex: 1;
      width: 100%;
      margin: 0 auto;
      padding: 8px 0;
      max-height: calc(100vh - 120px);
    }

    .controller-btn {
      flex: 1;
      min-height: 0;
      padding: clamp(12px, 3vh, 24px) clamp(16px, 4vw, 24px);
      font-size: clamp(1rem, 4vw, 1.4rem);
      font-weight: 700;
      border: none;
      border-radius: clamp(12px, 3vw, 20px);
      cursor: pointer;
      transition: all 0.15s ease;
      display: flex;
      align-items: center;
      gap: clamp(12px, 3vw, 20px);
      color: white;
      text-align: left;
      line-height: 1.25;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      overflow: hidden;
    }

    .controller-btn:nth-child(1) { background: linear-gradient(135deg, #c41e3a 0%, #a01830 100%); }
    .controller-btn:nth-child(2) { background: linear-gradient(135deg, #165B33 0%, #0d3d22 100%); }
    .controller-btn:nth-child(3) { background: linear-gradient(135deg, #0077be 0%, #005a8f 100%); }
    .controller-btn:nth-child(4) { background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%); }

    .controller-btn:active {
      transform: scale(0.97);
      filter: brightness(0.85);
    }

    .controller-btn.selected {
      box-shadow: 0 0 0 5px var(--color-accent), 0 0 30px var(--color-accent-glow);
      transform: scale(1.02);
    }

    .controller-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    .controller-btn .letter {
      width: clamp(40px, 12vw, 60px);
      height: clamp(40px, 12vw, 60px);
      min-width: clamp(40px, 12vw, 60px);
      border-radius: 50%;
      background: rgba(255,255,255,0.25);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: clamp(1.2rem, 5vw, 1.8rem);
      flex-shrink: 0;
    }

    .controller-btn .answer-text {
      flex: 1;
      font-size: clamp(1rem, 4vw, 1.35rem);
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
    }

    /* Controller waiting state */
    .controller-waiting {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: clamp(20px, 5vw, 40px);
    }

    .controller-waiting h2 {
      font-size: clamp(2.5rem, 10vw, 4rem);
      margin-bottom: 15px;
    }

    .controller-waiting .player-name-display {
      font-size: clamp(1.8rem, 8vw, 3rem);
      font-weight: 700;
      color: var(--color-accent);
      margin: 10px 0;
      word-break: break-word;
    }

    .controller-waiting .room-display {
      font-size: clamp(1.2rem, 5vw, 1.8rem);
      color: var(--color-text-muted);
      margin-bottom: 25px;
    }

    .controller-waiting .spinner {
      width: clamp(50px, 15vw, 80px);
      height: clamp(50px, 15vw, 80px);
      border: 6px solid var(--color-surface-light);
      border-top-color: var(--color-accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 25px auto;
    }

    .controller-waiting p {
      font-size: clamp(1.2rem, 5vw, 1.6rem);
      color: var(--color-text-muted);
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Controller answer submitted state */
    .controller-submitted {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: clamp(20px, 5vw, 40px);
    }

    .controller-submitted .checkmark {
      font-size: clamp(5rem, 20vw, 10rem);
      margin-bottom: 20px;
    }

    .controller-submitted h3 {
      font-size: clamp(2rem, 8vw, 3rem);
      color: var(--color-text);
      margin-bottom: 15px;
    }

    .controller-submitted p {
      font-size: clamp(1.2rem, 5vw, 1.6rem);
      color: var(--color-text-muted);
    }

    /* Controller feedback */
    .controller-feedback {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: clamp(20px, 5vw, 40px);
    }

    .controller-feedback .result-icon {
      font-size: clamp(6rem, 25vw, 12rem);
      margin-bottom: 15px;
    }

    .controller-feedback .result-text {
      font-size: clamp(2.5rem, 10vw, 4rem);
      font-weight: 800;
      margin-bottom: 20px;
    }

    .controller-feedback .result-text.correct { color: var(--color-correct); }
    .controller-feedback .result-text.wrong { color: var(--color-wrong); }

    .controller-feedback .correct-answer {
      font-size: clamp(1.2rem, 5vw, 1.8rem);
      color: var(--color-text);
      margin-bottom: 10px;
      padding: 0 10px;
    }

    .controller-feedback .correct-answer strong {
      color: var(--color-correct);
    }

    .controller-feedback .next-hint {
      font-size: clamp(1.1rem, 4vw, 1.5rem);
      color: var(--color-text-muted);
      margin-top: 30px;
    }

    /* Controller join form */
    .controller-join {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      padding: clamp(16px, 4vw, 30px);
    }

    .controller-join h1 {
      text-align: center;
      font-size: clamp(2.5rem, 10vw, 4rem);
      margin-bottom: clamp(25px, 6vh, 50px);
    }

    .controller-join .join-form {
      display: flex;
      flex-direction: column;
      gap: clamp(18px, 4vh, 30px);
      width: 100%;
      max-width: 450px;
      margin: 0 auto;
    }

    .controller-join label {
      display: flex;
      flex-direction: column;
      gap: 10px;
      font-weight: 600;
      font-size: clamp(1.1rem, 4vw, 1.4rem);
    }

    .controller-join .input-field {
      font-size: clamp(1.4rem, 5vw, 1.8rem);
      padding: clamp(14px, 3vh, 22px) clamp(16px, 4vw, 24px);
    }

    .controller-join .btn {
      margin-top: clamp(10px, 3vh, 20px);
      padding: clamp(16px, 4vh, 24px);
      font-size: clamp(1.2rem, 5vw, 1.5rem);
    }

    /* Controller final score */
    .controller-final {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: clamp(20px, 5vw, 40px);
    }

    .controller-final h2 {
      font-size: clamp(2.5rem, 10vw, 4rem);
      margin-bottom: 20px;
    }

    .controller-final .rank-display {
      font-size: clamp(5rem, 20vw, 10rem);
      font-weight: 800;
      color: var(--color-accent);
      margin: 5px 0;
      line-height: 1;
    }

    .controller-final .score-display {
      font-size: clamp(2rem, 8vw, 3.5rem);
      color: var(--color-text);
      margin-bottom: 30px;
    }

    .controller-final .look-up {
      font-size: clamp(1.2rem, 5vw, 1.6rem);
      color: var(--color-text-muted);
    }

    /* ========================================
       GAME SCREEN - HOST
       ======================================== */
    .game-header {
      position: fixed;
      top: 40px;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 30px;
      background: rgba(10, 18, 10, 0.9);
      backdrop-filter: blur(10px);
      z-index: 50;
    }

    .question-counter {
      font-family: var(--font-display);
      font-size: 1.5rem;
      color: var(--color-accent);
    }

    .timer {
      font-family: var(--font-body);
      font-size: 2rem;
      font-weight: 800;
      color: var(--color-text);
      background: var(--color-primary);
      padding: 10px 25px;
      border-radius: 50px;
      min-width: 80px;
      text-align: center;
    }

    .timer.warning {
      animation: pulse 0.5s ease-in-out infinite;
      background: var(--color-wrong);
    }

    .category-badge {
      background: var(--color-secondary);
      padding: 8px 20px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .question-container {
      text-align: center;
      max-width: 900px;
      width: 100%;
      padding-top: 100px;
    }

    .question-text {
      font-size: clamp(1.5rem, 4vw, 2.5rem);
      font-weight: 700;
      margin-bottom: 40px;
      line-height: 1.4;
    }

    .answers-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      max-width: 800px;
      margin: 0 auto;
    }

    @media (max-width: 600px) {
      .answers-grid { grid-template-columns: 1fr; }
    }

    .answer-option {
      padding: 25px 30px;
      background: var(--color-surface);
      border: 3px solid var(--color-secondary);
      border-radius: 15px;
      font-size: 1.2rem;
      font-weight: 600;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .answer-option .letter {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--color-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      flex-shrink: 0;
    }

    .answer-option.correct {
      border-color: var(--color-correct);
      background: rgba(34, 197, 94, 0.2);
    }

    .answer-option.correct .letter { background: var(--color-correct); }
    .answer-option.wrong { border-color: var(--color-wrong); opacity: 0.6; }

    /* ========================================
       RESULTS SCREEN
       ======================================== */
    .results-container {
      text-align: center;
      max-width: 700px;
      width: 100%;
    }

    .correct-answer-display {
      margin: 30px 0;
      padding: 20px 30px;
      background: rgba(34, 197, 94, 0.2);
      border: 2px solid var(--color-correct);
      border-radius: 15px;
      font-size: 1.3rem;
      font-weight: 700;
    }

    .who-got-it { margin: 20px 0; }
    .who-got-it h3 { font-size: 1.2rem; margin-bottom: 10px; color: var(--color-text-muted); }

    .correct-players {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }

    .correct-player {
      background: var(--color-correct);
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 600;
    }

    /* ========================================
       LEADERBOARD
       ======================================== */
    .leaderboard { margin: 30px 0; width: 100%; }
    .leaderboard h3 { margin-bottom: 15px; }
    .leaderboard-list { display: flex; flex-direction: column; gap: 8px; }

    .leaderboard-item {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 12px 20px;
      background: var(--color-surface-light);
      border-radius: 10px;
    }

    .leaderboard-item.top-1 { background: linear-gradient(135deg, #FFD700, #FFA500); color: #1a1a1a; }
    .leaderboard-item.top-2 { background: linear-gradient(135deg, #C0C0C0, #A0A0A0); color: #1a1a1a; }
    .leaderboard-item.top-3 { background: linear-gradient(135deg, #CD7F32, #B87333); color: #1a1a1a; }

    .rank { font-weight: 800; font-size: 1.2rem; width: 30px; }
    .leaderboard-name { flex: 1; font-weight: 600; }
    .leaderboard-score { font-weight: 800; font-size: 1.1rem; }

    /* ========================================
       FINAL RESULTS
       ======================================== */
    .final-results { text-align: center; }
    .winner-celebration { margin: 30px 0; }

    .trophy {
      font-size: 5rem;
      animation: bounce 1s ease-in-out infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-20px); }
    }

    .winner-name {
      font-family: var(--font-display);
      font-size: 3rem;
      color: var(--color-accent);
      margin: 20px 0;
    }

    .winner-score { font-size: 1.5rem; color: var(--color-text-muted); }
    .play-again-section { margin-top: 40px; }

    /* ========================================
       CONNECTION STATUS
       ======================================== */
    .connection-status {
      position: fixed;
      bottom: max(20px, var(--safe-bottom));
      left: 50%;
      transform: translateX(-50%);
      padding: 14px 28px;
      border-radius: 30px;
      font-size: 1.1rem;
      font-weight: 600;
      z-index: 100;
    }

    .connection-status.connected { background: var(--color-correct); color: white; }
    .connection-status.disconnected { background: var(--color-wrong); color: white; }
    .connection-status.connecting { background: var(--color-accent); color: #1a1a1a; }

    /* ========================================
       UTILITIES
       ======================================== */
    .hidden { display: none !important; }
    .text-center { text-align: center; }
    .mt-20 { margin-top: 20px; }
    .mb-20 { margin-bottom: 20px; }

    .error-message {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid var(--color-wrong);
      color: var(--color-wrong);
      padding: 15px 20px;
      border-radius: 10px;
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- Christmas Lights -->
    <div class="lights-wire"></div>
    <div class="lights-container" id="lights"></div>
    
    <!-- Screen content rendered by JS -->
    <div id="content"></div>
    
    <!-- Connection Status -->
    <div id="connection-status" class="connection-status hidden"></div>
  </div>

  <script>
    // ========================================
    // THEME CONFIGURATION
    // ========================================
    const THEME = {
      name: "Christmas",
      decorations: {
        snowfall: true,
        snowflakeCount: 50,
        lights: true,
        lightCount: 20
      }
    };

    // ========================================
    // GAME STATE
    // ========================================
    let gameState = {
      mode: null,
      phase: 'menu',
      roomCode: null,
      playerName: null,
      players: {},
      currentQuestion: null,
      questionIndex: 0,
      selectedQuestions: [],
      timeLeft: 20,
      timerInterval: null,
      showingResults: false,
      peer: null,
      connections: {},
      hostConnection: null,
      currentAnswer: null,
      resultsData: null,
      finalScores: null
    };

    // ========================================
    // PEER CONNECTION MANAGEMENT
    // ========================================
    function generateRoomCode() {
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      let code = '';
      for (let i = 0; i < 4; i++) {
        code += chars[Math.floor(Math.random() * chars.length)];
      }
      return code;
    }

    function initializeHost() {
      const roomCode = generateRoomCode();
      gameState.roomCode = roomCode;
      gameState.mode = 'host';
      
      const peerId = `xmas-trivia-${roomCode}`;
      gameState.peer = new Peer(peerId, { debug: 1 });

      gameState.peer.on('open', (id) => {
        console.log('Host peer opened with ID:', id);
        gameState.phase = 'lobby';
        render();
        generateQRCode();
      });

      gameState.peer.on('connection', (conn) => {
        console.log('New connection from:', conn.peer);
        
        conn.on('open', () => console.log('Connection opened'));
        conn.on('data', (data) => handleHostMessage(conn, data));
        conn.on('close', () => {
          const playerId = conn.peer;
          if (gameState.players[playerId]) {
            delete gameState.players[playerId];
            delete gameState.connections[playerId];
            broadcastToPlayers({ type: 'playerList', players: getPlayerList() });
            render();
          }
        });
      });

      gameState.peer.on('error', (err) => {
        console.error('Peer error:', err);
        if (err.type === 'unavailable-id') {
          gameState.peer.destroy();
          initializeHost();
        }
      });
    }

    function initializeController(roomCode, playerName) {
      gameState.mode = 'controller';
      gameState.roomCode = roomCode.toUpperCase();
      gameState.playerName = playerName;

      gameState.peer = new Peer({ debug: 1 });

      gameState.peer.on('open', (id) => {
        console.log('Controller peer opened:', id);
        
        const hostId = `xmas-trivia-${gameState.roomCode}`;
        const conn = gameState.peer.connect(hostId, { reliable: true });
        gameState.hostConnection = conn;

        conn.on('open', () => {
          console.log('Connected to host');
          conn.send({ type: 'join', name: playerName });
          showConnectionStatus('connected', 'Connected');
        });

        conn.on('data', (data) => handleControllerMessage(data));
        
        conn.on('close', () => {
          showConnectionStatus('disconnected', 'Disconnected');
          gameState.phase = 'menu';
          render();
        });

        conn.on('error', (err) => {
          console.error('Connection error:', err);
          showConnectionStatus('disconnected', 'Connection failed');
        });
      });

      gameState.peer.on('error', (err) => {
        console.error('Peer error:', err);
        showConnectionStatus('disconnected', 'Connection failed');
      });

      showConnectionStatus('connecting', 'Connecting...');
    }

    function handleHostMessage(conn, data) {
      const playerId = conn.peer;
      
      switch (data.type) {
        case 'join':
          if (Object.keys(gameState.players).length < 10) {
            gameState.players[playerId] = {
              name: data.name,
              score: 0,
              currentAnswer: null,
              answerTime: null
            };
            gameState.connections[playerId] = conn;
            
            conn.send({ type: 'joined', success: true });
            broadcastToPlayers({ type: 'playerList', players: getPlayerList() });
            render();
          } else {
            conn.send({ type: 'joined', success: false, reason: 'Game is full' });
          }
          break;
          
        case 'answer':
          if (gameState.phase === 'playing' && !gameState.showingResults) {
            const player = gameState.players[playerId];
            if (player && player.currentAnswer === null) {
              player.currentAnswer = data.answer;
              player.answerTime = data.time;
              
              const allAnswered = Object.values(gameState.players).every(p => p.currentAnswer !== null);
              if (allAnswered) showResults();
              
              render();
            }
          }
          break;
      }
    }

    function handleControllerMessage(data) {
      switch (data.type) {
        case 'joined':
          if (data.success) {
            gameState.phase = 'lobby';
          } else {
            alert(data.reason || 'Failed to join game');
            gameState.phase = 'menu';
          }
          render();
          break;
          
        case 'playerList':
          render();
          break;
          
        case 'gameStart':
          gameState.phase = 'playing';
          gameState.questionIndex = 0;
          render();
          break;
          
        case 'question':
          gameState.currentQuestion = data.question;
          gameState.questionIndex = data.index;
          gameState.timeLeft = data.timeLeft;
          gameState.showingResults = false;
          gameState.currentAnswer = null;
          render();
          break;
          
        case 'timeUpdate':
          gameState.timeLeft = data.timeLeft;
          render();
          break;
          
        case 'results':
          gameState.showingResults = true;
          gameState.resultsData = data;
          render();
          break;
          
        case 'finalResults':
          gameState.phase = 'final';
          gameState.finalScores = data.scores;
          render();
          break;
          
        case 'gameReset':
          gameState.phase = 'lobby';
          gameState.currentAnswer = null;
          gameState.showingResults = false;
          render();
          break;
      }
    }

    function broadcastToPlayers(message) {
      Object.values(gameState.connections).forEach(conn => {
        if (conn.open) conn.send(message);
      });
    }

    function getPlayerList() {
      return Object.entries(gameState.players).map(([id, player]) => ({
        id, name: player.name, score: player.score
      }));
    }

    // ========================================
    // GAME LOGIC
    // ========================================
    function selectQuestions() {
      const shuffled = [...QUESTIONS].sort(() => Math.random() - 0.5);
      gameState.selectedQuestions = shuffled.slice(0, 10);
    }

    function startGame() {
      if (Object.keys(gameState.players).length === 0) {
        alert('Need at least 1 player to start!');
        return;
      }
      
      selectQuestions();
      gameState.phase = 'playing';
      gameState.questionIndex = 0;
      
      broadcastToPlayers({ type: 'gameStart' });
      showQuestion();
    }

    function showQuestion() {
      const question = gameState.selectedQuestions[gameState.questionIndex];
      gameState.currentQuestion = question;
      gameState.timeLeft = 20;
      gameState.showingResults = false;
      
      Object.values(gameState.players).forEach(p => {
        p.currentAnswer = null;
        p.answerTime = null;
      });
      
      broadcastToPlayers({
        type: 'question',
        question: { category: question.category, question: question.question, answers: question.answers },
        index: gameState.questionIndex,
        timeLeft: gameState.timeLeft
      });
      
      render();
      startTimer();
    }

    function startTimer() {
      if (gameState.timerInterval) clearInterval(gameState.timerInterval);
      
      gameState.timerInterval = setInterval(() => {
        gameState.timeLeft--;
        broadcastToPlayers({ type: 'timeUpdate', timeLeft: gameState.timeLeft });
        
        if (gameState.timeLeft <= 0) showResults();
        render();
      }, 1000);
    }

    function showResults() {
      if (gameState.timerInterval) {
        clearInterval(gameState.timerInterval);
        gameState.timerInterval = null;
      }
      
      gameState.showingResults = true;
      
      const question = gameState.currentQuestion;
      const correctAnswer = question.correct;
      
      const results = [];
      Object.entries(gameState.players).forEach(([id, player]) => {
        if (player.currentAnswer === correctAnswer) {
          const speedBonus = Math.floor((player.answerTime / 20000) * 500);
          const points = 1000 + speedBonus;
          player.score += points;
          results.push({ name: player.name, correct: true, points });
        } else {
          results.push({ name: player.name, correct: false, points: 0 });
        }
      });
      
      broadcastToPlayers({
        type: 'results',
        correctAnswer: correctAnswer,
        correctAnswerText: question.answers[correctAnswer],
        results: results,
        scores: getPlayerList()
      });
      
      render();
      
      setTimeout(() => {
        if (gameState.questionIndex < 9) {
          gameState.questionIndex++;
          showQuestion();
        } else {
          showFinalResults();
        }
      }, 5000);
    }

    function showFinalResults() {
      gameState.phase = 'final';
      const scores = getPlayerList().sort((a, b) => b.score - a.score);
      gameState.finalScores = scores;
      broadcastToPlayers({ type: 'finalResults', scores: scores });
      render();
    }

    function resetGame() {
      Object.values(gameState.players).forEach(p => {
        p.score = 0;
        p.currentAnswer = null;
        p.answerTime = null;
      });
      
      gameState.phase = 'lobby';
      gameState.questionIndex = 0;
      gameState.currentQuestion = null;
      gameState.showingResults = false;
      
      broadcastToPlayers({ type: 'gameReset' });
      render();
    }

    function submitAnswer(answerIndex) {
      if (gameState.currentAnswer !== null) return;
      
      gameState.currentAnswer = answerIndex;
      const timeRemaining = gameState.timeLeft * 1000;
      
      gameState.hostConnection.send({
        type: 'answer',
        answer: answerIndex,
        time: timeRemaining
      });
      
      render();
    }

    // ========================================
    // UI RENDERING
    // ========================================
    function render() {
      const content = document.getElementById('content');
      
      if (gameState.mode === 'controller') {
        content.innerHTML = renderControllerView();
      } else {
        switch (gameState.phase) {
          case 'menu': content.innerHTML = renderMenu(); break;
          case 'lobby': content.innerHTML = renderHostLobby(); break;
          case 'playing': content.innerHTML = renderHostGame(); break;
          case 'final': content.innerHTML = renderFinalResults(); break;
        }
      }
      
      attachEventListeners();
    }

    function renderControllerView() {
      switch (gameState.phase) {
        case 'menu': return renderControllerJoin();
        case 'lobby': return renderControllerLobby();
        case 'playing': return renderControllerGame();
        case 'final': return renderControllerFinal();
        default: return renderControllerJoin();
      }
    }

    function renderMenu() {
      return `
        <div class="screen">
          <h1>üéÑ Christmas Trivia üéÑ</h1>
          <p class="subtitle">A festive party game for friends and family</p>
          
          <div class="mode-buttons">
            <div class="mode-btn" data-action="host">
              <svg viewBox="0 0 24 24"><path d="M21 3H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h5v2h8v-2h5c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 14H3V5h18v12z"/></svg>
              <span>Host Game</span>
              <small>Display on TV/Computer</small>
            </div>
            
            <div class="mode-btn" data-action="join">
              <svg viewBox="0 0 24 24"><path d="M17 1.01L7 1c-1.1 0-2 .9-2 2v18c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V3c0-1.1-.9-2-2-2zm0 18H7V5h10v14z"/></svg>
              <span>Join Game</span>
              <small>Use phone as controller</small>
            </div>
          </div>
        </div>
      `;
    }

    function renderHostLobby() {
      const players = Object.values(gameState.players);
      const playerCount = players.length;
      const joinUrl = window.location.href.split('?')[0];
      
      return `
        <div class="screen">
          <h2>üéÖ Game Lobby</h2>
          
          <div class="lobby-container">
            <div class="card join-info">
              <h3>Join the Game!</h3>
              <p>Scan the QR code or enter the code:</p>
              <div class="room-code">${gameState.roomCode}</div>
              <div class="qr-container">
                <canvas id="qr-code"></canvas>
              </div>
              <p class="join-url">${joinUrl}</p>
            </div>
            
            <div class="card players-section">
              <h3>üéÆ Players (${playerCount}/10)</h3>
              <div class="players-list">
                ${playerCount === 0 ? 
                  '<p class="waiting-text">Waiting for players to join...</p>' :
                  players.map((p, i) => `
                    <div class="player-item">
                      <div class="player-avatar" style="background: hsl(${(i * 36) % 360}, 70%, 50%)">${p.name[0].toUpperCase()}</div>
                      <span class="player-name">${escapeHtml(p.name)}</span>
                    </div>
                  `).join('')
                }
              </div>
              
              <div class="start-section">
                <p class="player-count">${playerCount} player${playerCount !== 1 ? 's' : ''} ready</p>
                <button class="btn btn-accent btn-large" data-action="start" ${playerCount === 0 ? 'disabled' : ''}>
                  Start Game
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderControllerJoin() {
      const params = new URLSearchParams(window.location.search);
      const roomCode = params.get('room') || '';
      
      return `
        <div class="controller-screen">
          <div class="controller-join">
            <h1>üéÑ Join Game</h1>
            
            <form class="join-form" id="join-form">
              <label>
                Room Code
                <input type="text" class="input-field" id="room-code" placeholder="XXXX" maxlength="4" autocomplete="off" style="text-transform: uppercase; font-size: 2rem; letter-spacing: 10px;" value="${roomCode}">
              </label>
              
              <label>
                Your Name
                <input type="text" class="input-field" id="player-name" placeholder="Enter your name" maxlength="15" autocomplete="off">
              </label>
              
              <button type="submit" class="btn btn-primary">Join Game</button>
            </form>
          </div>
        </div>
      `;
    }

    function renderControllerLobby() {
      return `
        <div class="controller-screen">
          <div class="controller-waiting">
            <h2>‚úÖ You're In!</h2>
            <div class="player-name-display">${escapeHtml(gameState.playerName)}</div>
            <div class="room-display">Room: ${gameState.roomCode}</div>
            <div class="spinner"></div>
            <p>Waiting for host to start...</p>
          </div>
        </div>
      `;
    }

    function renderControllerGame() {
      const question = gameState.currentQuestion;
      
      if (!question) {
        return `
          <div class="controller-screen">
            <div class="controller-waiting">
              <div class="spinner"></div>
              <p>Loading next question...</p>
            </div>
          </div>
        `;
      }
      
      if (gameState.showingResults) {
        const wasCorrect = gameState.currentAnswer === gameState.resultsData?.correctAnswer;
        return `
          <div class="controller-screen">
            <div class="controller-feedback">
              <div class="result-icon">${wasCorrect ? 'üéâ' : 'üò¢'}</div>
              <div class="result-text ${wasCorrect ? 'correct' : 'wrong'}">
                ${wasCorrect ? 'Correct!' : 'Wrong!'}
              </div>
              <div class="correct-answer">
                The answer was:<br>
                <strong>${escapeHtml(gameState.resultsData?.correctAnswerText || '')}</strong>
              </div>
              <div class="next-hint">Next question coming up...</div>
            </div>
          </div>
        `;
      }
      
      if (gameState.currentAnswer !== null) {
        return `
          <div class="controller-screen">
            <div class="controller-submitted">
              <div class="checkmark">‚úì</div>
              <h3>Answer Locked In!</h3>
              <p>Waiting for other players...</p>
            </div>
          </div>
        `;
      }
      
      const letters = ['A', 'B', 'C', 'D'];
      
      return `
        <div class="controller-screen">
          <div class="controller-header">
            <h2>Question ${gameState.questionIndex + 1}</h2>
            <div class="timer ${gameState.timeLeft <= 5 ? 'warning' : ''}">${gameState.timeLeft}</div>
          </div>
          
          <div class="controller-answers">
            ${question.answers.map((answer, i) => `
              <button class="controller-btn" data-action="answer" data-answer="${i}">
                <span class="letter">${letters[i]}</span>
                <span class="answer-text">${escapeHtml(answer)}</span>
              </button>
            `).join('')}
          </div>
        </div>
      `;
    }

    function renderControllerFinal() {
      const scores = gameState.finalScores || [];
      const myRank = scores.findIndex(s => s.name === gameState.playerName) + 1;
      const myScore = scores.find(s => s.name === gameState.playerName);
      
      return `
        <div class="controller-screen">
          <div class="controller-final">
            <h2>üéÑ Game Over! üéÑ</h2>
            <p>You finished</p>
            <div class="rank-display">#${myRank}</div>
            <div class="score-display">${myScore?.score.toLocaleString() || 0} points</div>
            <p class="look-up">Look at the main screen for full results!</p>
          </div>
        </div>
      `;
    }

    function renderHostGame() {
      const question = gameState.currentQuestion;
      if (!question) return '<div class="screen"><p>Loading...</p></div>';
      
      const letters = ['A', 'B', 'C', 'D'];
      const answeredCount = Object.values(gameState.players).filter(p => p.currentAnswer !== null).length;
      const totalPlayers = Object.keys(gameState.players).length;
      
      return `
        <div class="screen">
          <div class="game-header">
            <span class="question-counter">Question ${gameState.questionIndex + 1} / 10</span>
            <span class="category-badge">${question.category}</span>
            <div class="timer ${gameState.timeLeft <= 5 ? 'warning' : ''}">${gameState.timeLeft}</div>
          </div>
          
          <div class="question-container">
            <h2 class="question-text">${escapeHtml(question.question)}</h2>
            
            <div class="answers-grid">
              ${question.answers.map((answer, i) => `
                <div class="answer-option ${gameState.showingResults ? (i === question.correct ? 'correct' : 'wrong') : ''}">
                  <span class="letter">${letters[i]}</span>
                  <span>${escapeHtml(answer)}</span>
                </div>
              `).join('')}
            </div>
            
            ${!gameState.showingResults ? `
              <p class="mt-20" style="color: var(--color-text-muted)">
                ${answeredCount} / ${totalPlayers} players answered
              </p>
            ` : renderResultsSummary()}
          </div>
        </div>
      `;
    }

    function renderResultsSummary() {
      const question = gameState.currentQuestion;
      const correctPlayers = Object.values(gameState.players)
        .filter(p => p.currentAnswer === question.correct)
        .sort((a, b) => (b.answerTime || 0) - (a.answerTime || 0));
      
      return `
        <div class="results-container mt-20">
          <div class="correct-answer-display">
            ‚úì ${escapeHtml(question.answers[question.correct])}
          </div>
          
          ${correctPlayers.length > 0 ? `
            <div class="who-got-it">
              <h3>Got it right:</h3>
              <div class="correct-players">
                ${correctPlayers.map(p => `
                  <span class="correct-player">${escapeHtml(p.name)}</span>
                `).join('')}
              </div>
            </div>
          ` : '<p style="color: var(--color-text-muted)">No one got it right!</p>'}
          
          <div class="leaderboard">
            <h3>üèÜ Leaderboard</h3>
            <div class="leaderboard-list">
              ${getPlayerList()
                .sort((a, b) => b.score - a.score)
                .slice(0, 5)
                .map((p, i) => `
                  <div class="leaderboard-item ${i < 3 ? 'top-' + (i + 1) : ''}">
                    <span class="rank">${i + 1}</span>
                    <span class="leaderboard-name">${escapeHtml(p.name)}</span>
                    <span class="leaderboard-score">${p.score.toLocaleString()}</span>
                  </div>
                `).join('')}
            </div>
          </div>
        </div>
      `;
    }

    function renderFinalResults() {
      const scores = gameState.finalScores || [];
      const winner = scores[0];
      
      return `
        <div class="screen">
          <div class="final-results">
            <h1>üéÑ Game Over! üéÑ</h1>
            
            ${winner ? `
              <div class="winner-celebration">
                <div class="trophy">üèÜ</div>
                <div class="winner-name">${escapeHtml(winner.name)}</div>
                <div class="winner-score">${winner.score.toLocaleString()} points</div>
              </div>
            ` : ''}
            
            <div class="leaderboard" style="max-width: 500px; margin: 0 auto;">
              <h3>Final Standings</h3>
              <div class="leaderboard-list">
                ${scores.map((p, i) => `
                  <div class="leaderboard-item ${i < 3 ? 'top-' + (i + 1) : ''}">
                    <span class="rank">${i + 1}</span>
                    <span class="leaderboard-name">${escapeHtml(p.name)}</span>
                    <span class="leaderboard-score">${p.score.toLocaleString()}</span>
                  </div>
                `).join('')}
              </div>
            </div>
            
            <div class="play-again-section">
              <button class="btn btn-accent btn-large" data-action="playAgain">
                Play Again
              </button>
            </div>
          </div>
        </div>
      `;
    }

    // ========================================
    // EVENT HANDLING
    // ========================================
    function attachEventListeners() {
      document.querySelectorAll('[data-action="host"]').forEach(btn => {
        btn.addEventListener('click', () => initializeHost());
      });
      
      document.querySelectorAll('[data-action="join"]').forEach(btn => {
        btn.addEventListener('click', () => {
          gameState.mode = 'controller';
          gameState.phase = 'menu';
          render();
        });
      });
      
      document.querySelectorAll('[data-action="start"]').forEach(btn => {
        btn.addEventListener('click', startGame);
      });
      
      document.querySelectorAll('[data-action="answer"]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const answer = parseInt(e.currentTarget.dataset.answer);
          submitAnswer(answer);
        });
      });
      
      document.querySelectorAll('[data-action="playAgain"]').forEach(btn => {
        btn.addEventListener('click', resetGame);
      });
      
      const joinForm = document.getElementById('join-form');
      if (joinForm) {
        joinForm.addEventListener('submit', (e) => {
          e.preventDefault();
          const roomCode = document.getElementById('room-code').value.trim();
          const playerName = document.getElementById('player-name').value.trim();
          
          if (roomCode.length !== 4) {
            alert('Please enter a 4-character room code');
            return;
          }
          
          if (playerName.length < 1) {
            alert('Please enter your name');
            return;
          }
          
          initializeController(roomCode, playerName);
        });
      }
      
      if (document.getElementById('qr-code')) generateQRCode();
    }

    function generateQRCode() {
      const canvas = document.getElementById('qr-code');
      if (!canvas) return;
      
      const joinUrl = `${window.location.href.split('?')[0]}?room=${gameState.roomCode}`;
      
      QRCode.toCanvas(canvas, joinUrl, {
        width: 180,
        margin: 0,
        color: { dark: '#165B33', light: '#ffffff' }
      });
    }

    function showConnectionStatus(status, text) {
      const el = document.getElementById('connection-status');
      el.className = `connection-status ${status}`;
      el.textContent = text;
      el.classList.remove('hidden');
      
      if (status === 'connected') {
        setTimeout(() => el.classList.add('hidden'), 2000);
      }
    }

    // ========================================
    // DECORATIONS
    // ========================================
    function createDecorations() {
      if (THEME.decorations.snowfall) {
        for (let i = 0; i < THEME.decorations.snowflakeCount; i++) {
          const snowflake = document.createElement('div');
          snowflake.className = 'snowflake';
          snowflake.innerHTML = '‚ùÑ';
          snowflake.style.left = `${Math.random() * 100}%`;
          snowflake.style.fontSize = `${Math.random() * 10 + 8}px`;
          snowflake.style.animationDuration = `${Math.random() * 10 + 10}s`;
          snowflake.style.animationDelay = `${Math.random() * 10}s`;
          snowflake.style.opacity = Math.random() * 0.5 + 0.3;
          document.getElementById('app').appendChild(snowflake);
        }
      }
      
      if (THEME.decorations.lights) {
        const lightsContainer = document.getElementById('lights');
        for (let i = 0; i < THEME.decorations.lightCount; i++) {
          const bulb = document.createElement('div');
          bulb.className = 'light-bulb';
          lightsContainer.appendChild(bulb);
        }
      }
    }

    // ========================================
    // UTILITIES
    // ========================================
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ========================================
    // INITIALIZATION
    // ========================================
    function init() {
      createDecorations();
      
      const params = new URLSearchParams(window.location.search);
      const roomCode = params.get('room');
      
      if (roomCode) {
        gameState.mode = 'controller';
        gameState.phase = 'menu';
      }
      
      render();
      
      // Focus name input if joining
      setTimeout(() => {
        const nameInput = document.getElementById('player-name');
        if (nameInput && roomCode) nameInput.focus();
      }, 100);
    }

    init();
  </script>
</body>
</html>
